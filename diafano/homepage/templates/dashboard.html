{% if messg %}
<script>
    alert('{{ messg }}');
</script>
{% endif %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>diafano - signin/signup</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css'>

    <link rel="stylesheet" type="text/css" href = "{% static 'landing.css' %}">
    <link rel="stylesheet" type="text/css" href = "{% static 'login.css' %}">

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,600,700|Raleway:300,400,500,600,700" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/favicon.ico' %}"/>

    <script src='https://api.mapbox.com/mapbox-gl-js/v0.42.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.42.0/mapbox-gl.css' rel='stylesheet' />

    <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
</head>
<body>
  <ul>
    <li><a href="/">logout</a></li>
  </ul>
  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

  <div id='map' style='position: absolute; width: 100%; height: 100%;'></div>
  <style>
    .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
  </style>
  <script type="text/javascript">
    var firebase_config = {
      apiKey: "{{firebase_apikey}}",
      authDomain: "{{firebase_authdomain}}",
      databaseURL: "{{firebase_dburl}}",
      storageBucket: "{{firebase_storagebucket}}"
    };
    firebase.initializeApp(firebase_config);

    var database = firebase.database();

    var news = database.ref('news');
    var news_markers = [];
    news.on('value', function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
          var childData = childSnapshot.val();
          var news_data = {
              "type": "Feature",
              "properties": {
                  "description": "<p>" + childData['txt'] + "</p>",
                  "icon": "theatre"
              },
              "geometry": {
                  "type": "Point",
                  "coordinates": [childData['location']['longitude'], childData['location']['latitude']]
              }
          }
          news_markers.push(news_data);
        });
    });

    mapboxgl.accessToken = "{{mapbox_access_token}}";
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v10',
      zoom: 5.0,
      center: [32.75215,39.86927],
      pitch: 60
    });

    map.on("load", function () {
      map.loadImage("https://i.imgur.com/MK4NUzI.png", function(error, image) {
          if (error) throw error;
          map.addImage("custom-marker", image);
          map.addLayer({
            id: "markers",
            type: "symbol",
            source: {
              type: "geojson",
              data: {
                type: "FeatureCollection",
                features: news_markers
              }
            },
            layout: {
              "icon-image": "custom-marker",
            }
          });
        });

      map.on('click', 'markers', function (e) {
          var coordinates = e.features[0].geometry.coordinates.slice();
          var description = e.features[0].properties.description;

          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }

          new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
      });

      map.on('mouseenter', 'markers', function () {
          map.getCanvas().style.cursor = 'pointer';
      });

      // Change it back to the pointer when mouse leaves
      map.on('mouseleave', 'markers', function () {
          map.getCanvas().style.cursor = '';
      });

      map.addLayer({
        id: "clusters",
        type: "circle",
        source: "earthquakes",
        filter: ["has", "point_count"],
        paint: {
            // Use step expressions (https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
            // with three steps to implement three types of circles:
            //   * Blue, 20px circles when point count is less than 100
            //   * Yellow, 30px circles when point count is between 100 and 750
            //   * Pink, 40px circles when point count is greater than or equal to 750
            "circle-color": [
                "step",
                ["get", "point_count"],
                "#51bbd6",
                100,
                "#f1f075",
                750,
                "#f28cb1"
            ],
            "circle-radius": [
                "step",
                ["get", "point_count"],
                20,
                100,
                30,
                750,
                40
            ]
        }
    });

    map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "earthquakes",
        filter: ["has", "point_count"],
        layout: {
            "text-field": "{point_count_abbreviated}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12
        }
    });

    map.addLayer({
        id: "unclustered-point",
        type: "circle",
        source: "earthquakes",
        filter: ["!has", "point_count"],
        paint: {
            "circle-color": "#11b4da",
            "circle-radius": 4,
            "circle-stroke-width": 1,
            "circle-stroke-color": "#fff"
        }
    });
    });
  </script>
<script  src="{% static 'login.js' %}"></script>
</body>
</html>
